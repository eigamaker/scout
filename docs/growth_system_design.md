# 成長システム設計書

## 概要
選手の能力値成長を管理し、スカウトがデータ分析を通じて選手の成長速度や将来的な能力を予測できるシステム。

## 現在の成長システム

### 1. 成長タイミング
- **春の成長**: 2月4週～3月1週
- **夏の成長**: 8月5週～9月1週
- **頻度**: 年2回（半年ごと）
- **対象**: 高校生 + プロ選手（同じシステム）

### 2. 成長計算式
```
成長量 = 基本成長係数 × growthRate × 精神力補正 × 才能ランク補正 × ランダム係数 × ポテンシャル補正
```

#### 各係数の詳細
- **基本成長係数**: 学年と成長タイプに基づく（1-5）
- **growthRate**: 選手固有の成長速度（0.9-1.2）
- **精神力補正**: mentalGritに基づく（0.8-1.2）
- **才能ランク補正**: talentに基づく（1.0-1.5）
- **ランダム係数**: 0.7-1.3（確率分布あり）
- **ポテンシャル補正**: 現在値がポテンシャルに近づくほど減少（0.5-1.0）

### 3. 成長タイプ（再定義）

#### 早期成長型（early）
- **高校時代**: 1-2年生で急激に成長
- **プロ時代**: 20-24歳でピークに達し、その後緩やかに下降
- **ピーク年齢**: 24-28歳
- **特徴**: 若いうちから高いレベルに達するが、ポテンシャル到達は困難

#### 標準成長型（normal）
- **高校時代**: 着実に成長
- **プロ時代**: 30歳くらいまでゆっくり成長し続ける
- **ピーク年齢**: 28-32歳
- **特徴**: 安定した成長パターン

#### 遅咲き型（late）
- **高校時代**: 3年生になってから成長が加速
- **プロ時代**: 25歳以降に成長が加速し、35歳くらいまで成長
- **ピーク年齢**: 32-36歳
- **特徴**: 長期的な成長が見込める

**注意**: 急成長型（spurt）は削除。成長タイプと生涯ポテンシャルは独立しており、ポテンシャル150の選手でも早期成長型はポテンシャル到達が困難。

## 才能ランクとポテンシャルシステム

### 才能ランクの定義

| 才能ランク | 出現確率 | 平均ポテンシャル範囲 | 個別能力値範囲 | 到達可能レベル | 特徴 |
|------------|----------|---------------------|----------------|----------------|------|
| 1 | 49.9% | 60-75 | 50-85 | 高校生レベル | 一般レベル |
| 2 | 25% | 70-85 | 60-95 | 大学・社会人レベル | 中堅レベル |
| 3 | 20% | 80-95 | 70-105 | NPB二軍・一軍レベル | 上級レベル |
| 4 | 5% | 90-110 | 80-120 | NPBオールスター・MLBレベル | エリートレベル |
| 5 | 0.0996% | 100-130 | 90-150 | MLBスターレベル | スーパースター |
| 6 | 0.0004% | 130-150 | 90-150 | 伝説レベル | **怪物級（10年に1人）** |

### 才能ランク6の怪物システム

**才能ランク6**は「怪物級」の選手を表し、以下の特徴を持ちます：

#### 出現確率
- **確率**: 0.0004%（10年に1人程度）
- **年間28,200人**: 約10年に1人の怪物が出現

#### 能力値特徴
- **基本能力値**: 80（他のランクより大幅に高い）
- **球速**: 基本150km/h（3年生時に155km/hまで可能）
- **能力値上限**: 90（通常の100ではなく、バランス重視）
- **ポテンシャル**: 130-150（伝説級の成長上限）

#### 怪物の定義
- **1年生でも150km/h超え**: 学年制限を無視した超高速投球
- **全能力値90上限**: 突出しすぎないバランスの取れた怪物
- **伝説級ポテンシャル**: 最高レベルの成長上限をもつ

### ポテンシャルの概念

**ポテンシャル**は各能力値の**生涯を通じての最大到達可能値**を表します。

- **個別ポテンシャル**: 各能力値（制球、スタミナ、パワーなど）の個別の成長上限
- **才能基準値**: 才能ランクに基づく基準値（個別ポテンシャル生成の基準）
- **才能ランク**: 選手の総合的な才能レベルを決定し、才能基準値の範囲を制御

### 能力値とポテンシャルの関係

```
現在の能力値 ≤ 個別ポテンシャル（その能力値の上限）
```

- **高校生の能力値範囲**: 25-100（現行能力値）
- **高校生の球速範囲**: 125-155 km/h（現行球速）
- **個別ポテンシャル範囲**: 50-150（個別能力値の成長上限）
- **球速ポテンシャル範囲**: 125-170 km/h（球速の成長上限）

### ポテンシャル到達の現実性

#### 到達確率の例

| 才能ランク | 平均ポテンシャル | 到達確率 | 説明 |
|------------|------------------|----------|------|
| 1 | 60-75 | 5% | ほとんど到達しない |
| 2 | 70-85 | 10% | 少数が到達 |
| 3 | 80-95 | 20% | 努力次第で到達可能 |
| 4 | 90-110 | 30% | 比較的到達しやすい |
| 5 | 100-130 | 50% | 高い確率で到達 |
| 6 | 130-150 | 80% | ほぼ確実に到達 |

#### 到達に必要な要素

1. **幸運**: ランダム係数が好調な成長期が多い
2. **精神力**: mentalGritが高いほど成長効率が向上
3. **才能ランク**: 高ランクほど成長効率が向上
4. **成長タイプ**: 適切なタイミングでの成長
5. **練習環境**: チームの練習環境や指導力

## 成長タイプ別シミュレーション

### ランダム係数の詳細

| 範囲 | 出現確率 | 説明 |
|------|----------|------|
| 0.7-0.8 | 10% | 成長不振（怪我、スランプなど） |
| 0.8-0.9 | 15% | 成長鈍化（練習不足など） |
| 0.9-1.0 | 25% | 成長普通（標準的な成長） |
| 1.0-1.1 | 25% | 成長良好（練習効果あり） |
| 1.1-1.2 | 15% | 成長優秀（特別な練習効果） |
| 1.2-1.3 | 10% | 成長卓越（幸運な成長期） |

### Early型（早期成熟型）シミュレーション

**選手A（Early型）**
- 才能ランク: 3
- growthRate: 1.1
- mentalGrit: 0.7
- 才能基準値: 85
- 初期能力値: 65

| 時期 | 能力値 | 成長量 | 成長要因 |
|------|--------|--------|----------|
| 1年生開始 | 65 | - | 初期値 |
| 1年生春成長 | 68 | +3 | 基本成長+精神力補正 |
| 1年生夏成長 | 71 | +3 | 基本成長+ランダム好調 |
| 2年生春成長 | 73 | +2 | 成長減速+ポテンシャル接近 |
| 2年生夏成長 | 75 | +2 | 成長減速+ランダム普通 |
| 3年生春成長 | 77 | +2 | 成長減速+ポテンシャル制限 |
| 3年生夏成長 | 78 | +1 | 成長停滞+ポテンシャル到達 |

**特徴**: 1年生時点で既に高い能力値、成長は緩やかで早期にポテンシャルに到達

### Normal型（標準成長型）シミュレーション

**選手B（Normal型）**
- 才能ランク: 3
- growthRate: 1.0
- mentalGrit: 0.65
- 才能基準値: 85
- 初期能力値: 55

| 時期 | 能力値 | 成長量 | 成長要因 |
|------|--------|--------|----------|
| 1年生開始 | 55 | - | 初期値 |
| 1年生春成長 | 59 | +4 | 標準成長+ランダム好調 |
| 1年生夏成長 | 63 | +4 | 標準成長+精神力補正 |
| 2年生春成長 | 68 | +5 | 成長加速+ランダム好調 |
| 2年生夏成長 | 73 | +5 | 成長加速+才能ランク補正 |
| 3年生春成長 | 78 | +5 | 成長維持+ランダム好調 |
| 3年生夏成長 | 82 | +4 | 成長減速+ポテンシャル接近 |

**特徴**: 標準的な成長パターン、3年生でピークに達する

### Late型（晩成型）シミュレーション

**選手C（Late型）**
- 才能ランク: 3
- growthRate: 0.95
- mentalGrit: 0.6
- 才能基準値: 85
- 初期能力値: 45

| 時期 | 能力値 | 成長量 | 成長要因 |
|------|--------|--------|----------|
| 1年生開始 | 45 | - | 初期値 |
| 1年生春成長 | 48 | +3 | 緩やか成長+ランダム普通 |
| 1年生夏成長 | 51 | +3 | 緩やか成長+ランダム普通 |
| 2年生春成長 | 55 | +4 | 成長加速+ランダム好調 |
| 2年生夏成長 | 60 | +5 | 成長加速+精神力補正 |
| 3年生春成長 | 68 | +8 | 急成長+ランダム好調 |
| 3年生夏成長 | 75 | +7 | 急成長+才能ランク補正 |

**特徴**: 初期は緩やか、3年生で急激に成長

### 成長シミュレーションの実装例

```dart
// 成長計算の疑似コード
double calculateGrowth(Player player, Ability ability) {
  double baseGrowth = getBaseGrowth(player.grade, player.growthType);
  double growthRate = player.growthRate;
  double mentalGrit = player.mentalGrit;
  double talentBonus = getTalentBonus(player.talent);
  double randomFactor = getRandomFactor(); // 0.7-1.3
  double potentialPenalty = getPotentialPenalty(player.currentAbility, player.potential);
  
  return baseGrowth * growthRate * (0.8 + mentalGrit * 0.4) * talentBonus * randomFactor * potentialPenalty;
}
```

### その他のランダム要素

1. **成長タイミングのランダム性**
   - 2月4週～3月1週の間でランダムに成長
   - 8月5週～9月1週の間でランダムに成長

2. **能力値別成長のランダム性**
   - 各能力値で個別にランダム係数を適用
   - 同じ選手でも能力値によって成長量が異なる

3. **ポテンシャル到達のランダム性**
   - ポテンシャルの80%に達すると成長が困難
   - ポテンシャルの90%に達すると成長が極めて困難
   - ポテンシャル到達は運の要素が大きい

## 成長履歴管理システム（詳細版）

### 1. 成長履歴の記録条件

#### 記録開始条件
- **発掘済み選手のみ**: スカウトが発掘した選手のみ履歴を記録
- **発掘時点から記録開始**: 発掘された時点のScoutAnalysisデータを履歴に挿入
- **個人差のある履歴期間**: 
  - 高校3年生で発掘 → 3年生から履歴開始
  - 高校1年生で発掘 → 1年生から履歴開始

#### 記録継続条件
- **視察による更新**: スカウトが視察するたびに成長履歴を更新
- **成長後の視察必須**: 成長後の正確な数値を得るには視察が必要

### 2. スカウト分析データの履歴化

#### ScoutAnalysis履歴テーブル
```sql
CREATE TABLE ScoutAnalysisHistory (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  player_id INTEGER,
  scout_id TEXT,
  analysis_date TEXT, -- YYYY-MM-DD形式
  analysis_accuracy REAL, -- 0.0-1.0（分析精度）
  
  -- スカウト分析した能力値（履歴）
  contact_analyzed INTEGER,
  power_analyzed INTEGER,
  -- ... 他の能力値
  
  -- 分析時のメタデータ
  growth_period TEXT, -- 'spring' または 'summer'
  is_post_growth BOOLEAN, -- 成長後の分析かどうか
  
  created_at TEXT,
  FOREIGN KEY (player_id) REFERENCES Player (id)
)
```

#### 履歴記録の流れ
1. **発掘時**: ScoutAnalysisデータをScoutAnalysisHistoryに挿入
2. **成長時**: Playerテーブルのデータを更新（実際の成長）
3. **視察時**: 成長後の正確な数値をScoutAnalysisHistoryに記録

### 3. スカウト分析精度の管理

#### 分析精度の定義
- **発掘時**: スカウトの能力値に基づく精度（0-100%）
- **視察による更新**: 視察するたびに精度が向上
- **時間経過による劣化**: 視察していない期間で精度が低下

#### 分析精度の計算式
```
現在の精度 = 前回視察時の精度 × (0.9 ^ 経過成長回数)
```

#### 精度劣化の仕組み
- **半年ごとに10%劣化**: 成長のタイミングに合わせて劣化
- **視察による回復**: 視察するたびに精度が100%に回復
- **最低精度**: 30%（完全に不明な状態を避ける）

### 4. スカウトアクションとの連動

#### 視察アクションの効果
- **練習視察**: 技術面の能力値精度が向上
- **試合視察**: メンタル面・フィジカル面の能力値精度が向上
- **分析精度の回復**: 視察するたびに精度が100%に回復

#### 視察タイプ別の精度向上
- **練習視察**: 技術系能力値の精度+20%
- **試合視察**: メンタル・フィジカル系能力値の精度+20%
- **総合視察**: 全能力値の精度+15%

### 5. 成長履歴の活用

#### 成長分析のためのデータ
- **発掘時点からの履歴**: 選手によって異なる履歴期間
- **スカウト分析データ**: 実際のスカウトが分析した数値のみ
- **精度情報**: 各履歴の信頼度を考慮した分析

#### 成長予測への活用
- **精度の高い履歴**: より正確な成長パターンの分析
- **精度の低い履歴**: 補完データとして活用
- **視察頻度**: 選手の注目度の指標として活用

## 成長履歴管理システム（修正版）

### 1. 記録条件（修正）
**修正前**: 視察済み選手、注目選手、発掘済み選手
**修正後**: 
- **発掘済み選手のみ**: スカウトが発掘した選手のみ履歴を記録
- **発掘時点から記録開始**: 個人差のある履歴期間

**理由**: 注目選手（fameレベル）は知名度のみで、実際のスカウト活動とは無関係

### 2. スカウトシステムの進捗管理（新規追加）

#### スカウト状態の定義
```
スカウト状態レベル:
- レベル0: 未発見
- レベル1: 1回視察（基本情報のみ）
- レベル2: 2回視察（能力値の一部が判明）
- レベル3: 3回視察（全能力値が判明）
- レベル4: 発掘済み
```

#### 視察アクションの進捗率
- **練習視察**: 1回で1-3人の選手を発見
- **試合視察**: 1回で3-5人の選手を発見
- **進捗率**: 視察回数に応じて情報開示率が上昇

#### 視察タイプの区別
- **練習視察**: 技術面の能力値が詳細に判明
- **試合視察**: メンタル面・フィジカル面の能力値が詳細に判明

### 3. 処理負荷の考慮

#### 現在の処理対象
- **高校生**: 28000選手 × 3学年 = 84,000選手
- **プロ選手**: 推定5000選手
- **合計**: 約89,000選手

#### 処理負荷の軽減案
1. **記録条件の厳格化**: 発掘済み選手のみ記録により対象を大幅削減
2. **成長係数の簡素化**: 複雑な計算を避け、主要な係数のみ使用
3. **バッチ処理**: 成長処理を非同期で実行
4. **データ圧縮**: 成長量のみを保存し、詳細データは必要時のみ計算

**質問**: 処理負荷の軽減案は適切ですか？

## 統合完了後の設計概要

### 成長システムの完全統合

このドキュメントに以下が統合されました：

1. **成長計算式**: 基本成長係数、growthRate、精神力補正、才能ランク補正、ランダム係数、ポテンシャル補正
2. **才能ランクシステム**: 1-6段階の詳細定義と出現確率
3. **ポテンシャルシステム**: 個別ポテンシャルと才能基準値の関係
4. **成長タイプ別シミュレーション**: Early、Normal、Late型の詳細例
5. **成長履歴管理**: 発掘済み選手の履歴記録とスカウト分析精度管理

### 実装の優先順位

**Phase 1**: 基本成長システム
- 成長タイプの実装（early/normal/late）
- 才能ランクとポテンシャル生成
- 基本成長計算式の実装

**Phase 2**: 成長履歴記録
- ScoutAnalysis履歴テーブルの作成
- 発掘時の履歴記録機能
- 視察による履歴更新機能

**Phase 3**: 分析精度管理
- 分析精度の計算システム
- 視察による精度回復機能
- 時間経過による精度劣化機能

**Phase 4**: 成長分析機能
- 成長速度・一貫性の計算
- スカウト画面での表示

**Phase 5**: 予測システム
- 将来能力値の予測
- ピーク年齢の予測

### 関連ファイルとの連携

- **`ability_values_design.md`**: 基本能力値の定義と範囲
- **`scout_system_design_v2.md`**: スカウトシステムとの連携
- **実装ファイル**: 成長計算とデータ管理の実装

### 次のステップ

成長システムの設計が統合されました。実装時は以下の順序で進めることを推奨します：

1. **基本成長システム**の実装
2. **才能ランクとポテンシャル**の生成システム
3. **成長履歴管理**の段階的実装
4. **スカウト分析精度**の管理システム
5. **成長予測機能**の実装 