# 成長システム設計書

## 概要
選手の能力値成長を管理し、スカウトがデータ分析を通じて選手の成長速度や将来的な能力を予測できるシステム。

## 現在の成長システム

### 1. 成長タイミング
- **春の成長**: 週5（5月1週）
- **夏の成長**: 週17（8月1週）
- **秋の成長**: 週29（11月1週）
- **冬の成長**: 週41（2月1週）
- **頻度**: 年4回（3ヶ月ごと）
- **対象**: 高校生 + プロ選手（同じシステム）

### 2. 成長計算式
```
成長量 = 基本成長係数 × growthRate × 精神力補正 × 才能ランク補正 × ランダム係数 × ポテンシャル補正
```

#### 各係数の詳細
- **基本成長係数**: 年齢と成長タイプに基づく（-0.4〜1.2）
- **growthRate**: 選手固有の成長速度（0.85-1.15）
- **精神力補正**: mentalGritに基づく（0.8-1.2）
- **才能ランク補正**: talentに基づく（0.8-1.3）
- **ランダム係数**: 0.7-1.2（確率分布あり）
- **ポテンシャル補正**: 現在値がポテンシャルに近づくほど減少（0.2-1.0）

### 3. 成長タイプ

#### 早期成長型（early）
- **高校時代**: 標準的な成長（成長タイプによる差なし）
- **プロ時代**: 20-24歳でピークに達し、その後緩やかに下降
- **ピーク年齢**: 24-28歳
- **特徴**: 若いうちから高いレベルに達するが、ポテンシャル到達は困難

#### 標準成長型（normal）
- **高校時代**: 標準的な成長（成長タイプによる差なし）
- **プロ時代**: 30歳くらいまでゆっくり成長し続ける
- **ピーク年齢**: 28-32歳
- **特徴**: 安定した成長パターン

#### 遅咲き型（late）
- **高校時代**: 標準的な成長（成長タイプによる差なし）
- **プロ時代**: 25歳以降に成長が加速し、35歳くらいまで成長
- **ピーク年齢**: 32-36歳
- **特徴**: 長期的な成長が見込める

#### 急成長型（spurt）
- **高校時代**: 標準的な成長（成長タイプによる差なし）
- **プロ時代**: 21-27歳でやや高めの成長
- **特徴**: 短期間での急成長

**注意**: 高校時代（15-20歳）では成長タイプによる差はなく、すべての選手が標準的な成長をします。成長タイプによる差はプロ時代（21歳以降）から現れます。

## 才能ランクとポテンシャルシステム

### 才能ランクの定義

| 才能ランク | 出現確率 | 平均ポテンシャル範囲 | 個別能力値範囲 | 到達可能レベル | 特徴 |
|------------|----------|---------------------|----------------|----------------|------|
| 1 | 70% | 60-75 | 50-85 | 高校生レベル | 一般レベル |
| 2 | 23% | 70-85 | 60-95 | 大学・社会人レベル | 中堅レベル |
| 3 | 5% | 80-95 | 70-105 | NPB二軍・一軍レベル | 上級レベル |
| 4 | 2% | 90-110 | 80-120 | NPBオールスター・MLBレベル | エリートレベル |
| 5 | 0.01% | 100-130 | 90-150 | MLBスターレベル | スーパースター |
| 6 | 0.0004% | 120-150 | 90-150 | 伝説レベル | **怪物級（10年に1人程度）** |

### 才能ランク6の怪物システム

**才能ランク6**は「怪物級」の選手を表し、以下の特徴を持ちます：

#### 出現確率
- **確率**: 0.0004%（10年に1人程度）
- **年間28,200人**: 約10年に1人の怪物が出現

#### 能力値特徴
- **基本能力値**: 80（他のランクより大幅に高い）
- **球速**: 基本155km/h（3年生時に最大155km/hまで可能）
- **能力値上限**: 90（通常の100ではなく、バランス重視）
- **ポテンシャル**: 120-150（伝説級の成長上限）

#### 怪物の定義
- **1年生でも150km/h超え**: 学年制限を無視した超高速投球
- **全能力値90上限**: 突出しすぎないバランスの取れた怪物
- **伝説級ポテンシャル**: 最高レベルの成長上限をもつ

### ポテンシャルの概念

**ポテンシャル**は各能力値の**生涯を通じての最大到達可能値**を表します。

- **個別ポテンシャル**: 各能力値（制球、スタミナ、パワーなど）の個別の成長上限
- **才能基準値**: 才能ランクに基づく基準値（個別ポテンシャル生成の基準）
- **才能ランク**: 選手の総合的な才能レベルを決定し、才能基準値の範囲を制御

### 能力値とポテンシャルの関係

```
現在の能力値 ≤ 個別ポテンシャル（その能力値の上限）
```

- **高校生の能力値範囲**: 25-100（現行能力値）
- **高校生の球速範囲**: 125-155 km/h（現行球速）
- **個別ポテンシャル範囲**: 50-150（個別能力値の成長上限）
- **球速ポテンシャル範囲**: 125-170 km/h（球速の成長上限）

### ポテンシャル到達の現実性

#### ポテンシャル補正係数による制御

実装では、現在の能力値がポテンシャルの何%に達しているかによって成長の困難度が決まります：

| 到達率 | 補正係数 | 成長の困難度 | 説明 |
|--------|----------|--------------|------|
| **90%以上** | **0.2** | **極めて困難** | ポテンシャルにほぼ到達、成長は極めて困難 |
| **80-89%** | **0.5** | **困難** | ポテンシャルに近づき、成長が困難 |
| **80%未満** | **1.0** | **標準** | 標準的な成長が可能 |

#### 才能ランクによる到達しやすさの差

**才能ランクによる差は成長効率で表現**され、個別の到達確率は設定されていません：

- **高ランク（4-6）**: 成長係数が高く、ポテンシャルに到達しやすい
- **中ランク（2-3）**: 標準的な成長効率
- **低ランク（1）**: 成長係数が低く、ポテンシャルに到達しにくい

#### 到達に必要な要素

1. **幸運**: ランダム係数が好調な成長期が多い
2. **精神力**: mentalGritが高いほど成長効率が向上
3. **才能ランク**: 高ランクほど成長効率が向上
4. **成長タイプ**: 適切なタイミングでの成長
5. **練習環境**: チームの練習環境や指導力

## 成長タイプ別シミュレーション

### ランダム係数の詳細

| 範囲 | 出現確率 | 説明 |
|------|----------|------|
| 0.7 | 10% | 成長不振（怪我、スランプなど） |
| 0.8 | 15% | 成長鈍化（練習不足など） |
| 0.9 | 25% | 成長普通（標準的な成長） |
| 1.0 | 25% | 成長良好（練習効果あり） |
| 1.1 | 15% | 成長優秀（特別な練習効果） |
| 1.2 | 10% | 成長卓越（幸運な成長期） |

### Early型（早期成熟型）シミュレーション

**選手A（Early型）**
- 才能ランク: 3
- growthRate: 1.1
- mentalGrit: 0.7
- 才能基準値: 85
- 初期能力値: 65

| 時期 | 能力値 | 成長量 | 成長要因 |
|------|--------|--------|----------|
| 1年生開始 | 65 | - | 初期値 |
| 1年生春成長 | 68 | +3 | 基本成長+精神力補正 |
| 1年生夏成長 | 71 | +3 | 基本成長+ランダム好調 |
| 2年生春成長 | 73 | +2 | 成長減速+ポテンシャル接近 |
| 2年生夏成長 | 75 | +2 | 成長減速+ランダム普通 |
| 3年生春成長 | 77 | +2 | 成長減速+ポテンシャル制限 |
| 3年生夏成長 | 78 | +1 | 成長停滞+ポテンシャル到達 |

**特徴**: 1年生時点で既に高い能力値、成長は緩やかで早期にポテンシャルに到達

### Normal型（標準成長型）シミュレーション

**選手B（Normal型）**
- 才能ランク: 3
- growthRate: 1.0
- mentalGrit: 0.7
- 才能基準値: 85
- 初期能力値: 55

| 時期 | 能力値 | 成長量 | 成長要因 |
|------|--------|--------|----------|
| 1年生開始 | 55 | - | 初期値 |
| 1年生春成長 | 59 | +4 | 標準成長+ランダム好調 |
| 1年生夏成長 | 63 | +4 | 標準成長+精神力補正 |
| 2年生春成長 | 68 | +5 | 成長加速+ランダム好調 |
| 2年生夏成長 | 73 | +5 | 成長加速+才能ランク補正 |
| 3年生春成長 | 78 | +5 | 成長維持+ランダム好調 |
| 3年生夏成長 | 82 | +4 | 成長減速+ポテンシャル接近 |

**特徴**: 標準的な成長パターン、3年生でピークに達する

### Late型（晩成型）シミュレーション

**選手C（Late型）**
- 才能ランク: 3
- growthRate: 0.95
- mentalGrit: 0.6
- 才能基準値: 85
- 初期能力値: 45

| 時期 | 能力値 | 成長量 | 成長要因 |
|------|--------|--------|----------|
| 1年生開始 | 45 | - | 初期値 |
| 1年生春成長 | 48 | +3 | 緩やか成長+ランダム普通 |
| 1年生夏成長 | 51 | +3 | 緩やか成長+ランダム普通 |
| 2年生春成長 | 55 | +4 | 成長加速+ランダム好調 |
| 2年生夏成長 | 60 | +5 | 成長加速+精神力補正 |
| 3年生春成長 | 68 | +8 | 急成長+ランダム好調 |
| 3年生夏成長 | 75 | +7 | 急成長+才能ランク補正 |

**特徴**: 初期は緩やか、3年生で急激に成長

### 成長シミュレーションの実装例

```dart
// 成長計算の疑似コード
double calculateGrowth(Player player, Ability ability) {
  double baseGrowth = getBaseGrowth(player.age, player.growthType);
  double growthRate = player.growthRate;
  double mentalGrit = player.mentalGrit;
  double talentBonus = getTalentBonus(player.talent);
  double randomFactor = getRandomFactor(); // 0.7-1.2
  double potentialPenalty = getPotentialPenalty(player.currentAbility, player.potential);
  
  return baseGrowth * growthRate * (0.8 + mentalGrit * 0.4) * talentBonus * randomFactor * potentialPenalty;
}
```

### その他のランダム要素

1. **成長タイミングの固定性**
   - 5月1週、8月1週、11月1週、2月1週で固定成長
   - ランダム性は成長量のみ

2. **能力値別成長のランダム性**
   - 各能力値で個別にランダム係数を適用
   - 同じ選手でも能力値によって成長量が異なる
   - **成長量の制限**: -5から10の範囲（マイナス成長も許可）

3. **ポテンシャル到達のランダム性**
   - ポテンシャルの80%に達すると成長が困難
   - ポテンシャルの90%に達すると成長が極めて困難
   - ポテンシャル到達は運の要素が大きい

## 年齢別成長システム

### 年齢段階の定義

| 年齢段階 | 年齢範囲 | 特徴 |
|----------|----------|------|
| **Young** | 15-20歳 | 高校生時代、成長タイプによる差なし（一律の成長） |
| **Prime** | 21-27歳 | プロ野球の黄金期、成長タイプによる差が現れる |
| **Mature** | 28-32歳 | 成熟期、成長停止または継続（成長タイプによる差あり） |
| **Decline** | 33-36歳 | 能力値減退開始（成長タイプによる差あり） |
| **Retirement** | 37歳以上 | 大幅減退、引退間近（全選手共通） |

### 成長タイプ別年齢係数

**高校時代（15-20歳）**: 全成長タイプで一律の成長係数1.0

#### Early型（早期成熟型）
- **Young (15-20歳)**: 1.0（高校時代は標準成長）
- **Prime (21-27歳)**: 1.0（標準成長）
- **Mature (28-32歳)**: -0.2（減退開始）
- **Decline (33-36歳)**: -0.3（減退加速）
- **Retirement (37歳以上)**: -0.4（大幅減退）

#### Normal型（標準成長型）
- **Young (15-20歳)**: 1.0（高校時代は標準成長）
- **Prime (21-27歳)**: 1.2（成長率高め）
- **Mature (28-32歳)**: 0.0（成長停止）
- **Decline (33-36歳)**: -0.2（能力値減退）
- **Retirement (37歳以上)**: -0.4（大幅減退）

#### Late型（晩成型）
- **Young (15-20歳)**: 1.0（高校時代は標準成長）
- **Prime (21-27歳)**: 1.0（標準成長）
- **Mature (28-32歳)**: 0.8（成長継続）
- **Decline (33-36歳)**: -0.1（軽微な減退）
- **Retirement (37歳以上)**: -0.4（大幅減退）

#### Spurt型（急成長型）
- **Young (15-20歳)**: 1.0（高校時代は標準成長）
- **Prime (21-27歳)**: 1.1（やや高め）
- **Mature (28-32歳)**: 0.0（成長停止）
- **Decline (33-36歳)**: -0.2（能力値減退）
- **Retirement (37歳以上)**: -0.4（大幅減退）

### 2. スカウト分析データの履歴化

#### ScoutAnalysis履歴テーブル
```sql
CREATE TABLE ScoutAnalysisHistory (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  player_id INTEGER,
  scout_id TEXT,
  analysis_date TEXT, -- YYYY-MM-DD形式
  analysis_accuracy REAL, -- 0.0-1.0（分析精度）
  
  -- スカウト分析した能力値（履歴）
  contact_analyzed INTEGER,
  power_analyzed INTEGER,
  -- ... 他の能力値
  
  -- 分析時のメタデータ
  growth_period TEXT, -- 'spring' または 'summer'
  is_post_growth BOOLEAN, -- 成長後の分析かどうか
  
  created_at TEXT,
  FOREIGN KEY (player_id) REFERENCES Player (id)
)
```

#### 履歴記録の流れ
1. **発掘時**: ScoutAnalysisデータをScoutAnalysisHistoryに挿入
2. **成長時**: Playerテーブルのデータを更新（実際の成長）
3. **視察時**: 成長後の正確な数値をScoutAnalysisHistoryに記録

### 3. スカウト分析精度の管理

#### 分析精度の定義
- **発掘時**: スカウトの能力値に基づく精度（0-100%）
- **視察による更新**: 視察するたびに精度が向上
- **時間経過による劣化**: 視察していない期間で精度が低下

#### 分析精度の計算式
```
現在の精度 = 前回視察時の精度 × (0.9 ^ 経過成長回数)
```

#### 精度劣化の仕組み
- **半年ごとに10%劣化**: 成長のタイミングに合わせて劣化
- **視察による回復**: 視察するたびに精度が100%に回復
- **最低精度**: 30%（完全に不明な状態を避ける）

### 4. スカウトアクションとの連動

#### 視察アクションの効果
- **練習視察**: フィジカル面の能力値精度が向上（実装済み）
- **分析精度の回復**: 視察するたびに精度が100%に回復

#### 視察タイプ別の精度向上
- **練習視察**: フィジカル系能力値の精度+20%（実装済み）

### 5. 成長履歴の活用

#### 成長分析のためのデータ
- **発掘時点からの履歴**: 選手によって異なる履歴期間
- **スカウト分析データ**: 実際のスカウトが分析した数値のみ
- **精度情報**: 各履歴の信頼度を考慮した分析

#### 成長予測への活用
- **精度の高い履歴**: より正確な成長パターンの分析
- **精度の低い履歴**: 補完データとして活用
- **視察頻度**: 選手の注目度の指標として活用

## 成長履歴管理システム（実装済み機能のみ）

### 1. 記録条件
- **発掘済み選手のみ**: スカウトが発掘した選手のみ履歴を記録
- **発掘時点から記録開始**: 個人差のある履歴期間

### 2. 処理負荷の考慮

#### 現在の処理対象
- **高校生**: 28000選手 × 3学年 = 84,000選手
- **プロ選手**: 推定5000選手
- **合計**: 約89,000選手

#### 処理負荷の軽減案
1. **記録条件の厳格化**: 発掘済み選手のみ記録により対象を大幅削減
2. **成長係数の簡素化**: 複雑な計算を避け、主要な係数のみ使用
3. **バッチ処理**: 成長処理を非同期で実行
4. **データ圧縮**: 成長量のみを保存し、詳細データは必要時のみ計算

## 統合完了後の設計概要

### 成長システムの完全統合

このドキュメントに以下が統合されました：

1. **成長計算式**: 基本成長係数、growthRate、精神力補正、才能ランク補正、ランダム係数、ポテンシャル補正
2. **才能ランクシステム**: 1-6段階の詳細定義と出現確率
3. **ポテンシャルシステム**: 個別ポテンシャルと才能基準値の関係
4. **成長タイプ別シミュレーション**: Early、Normal、Late型の詳細例
5. **成長履歴管理**: 発掘済み選手の履歴記録とスカウト分析精度管理

### 実装の優先順位

**Phase 1**: 基本成長システム
- 成長タイプの実装（early/normal/late）
- 才能ランクとポテンシャル生成
- 基本成長計算式の実装

**Phase 2**: 成長履歴記録
- ScoutAnalysis履歴テーブルの作成
- 発掘時の履歴記録機能
- 視察による履歴更新機能

**Phase 3**: 分析精度管理
- 分析精度の計算システム
- 視察による精度回復機能
- 時間経過による精度劣化機能

**Phase 4**: 成長分析機能
- 成長速度・一貫性の計算
- スカウト画面での表示

**Phase 5**: 予測システム
- 将来能力値の予測
- ピーク年齢の予測

### 関連ファイルとの連携

- **`ability_values_design.md`**: 基本能力値の定義と範囲
- **`scout_system_design_v2.md`**: スカウトシステムとの連携
- **実装ファイル**: 成長計算とデータ管理の実装

### 次のステップ

成長システムの設計が統合されました。実装時は以下の順序で進めることを推奨します：

1. **基本成長システム**の実装
2. **才能ランクとポテンシャル**の生成システム
3. **成長履歴管理**の段階的実装
4. **スカウト分析精度**の管理システム
5. **成長予測機能**の実装 